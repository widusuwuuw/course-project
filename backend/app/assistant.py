from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import Optional, Literal
import os
from .services.deepseek_client import generate_answer, DeepSeekUnavailable as LLMUnavailable, is_enabled as llm_enabled

DISCLAIMER = (
    "æœ¬åŠ©æ‰‹ä»…æä¾›ä¸€èˆ¬æ€§çš„å¥åº·ç§‘æ™®ä¸ç”Ÿæ´»æ–¹å¼å»ºè®®ï¼Œä¸èƒ½æ›¿ä»£åŒ»ç”Ÿçš„è¯Šæ–­æˆ–å¤„æ–¹ã€‚"
    "å¦‚æœ‰ç´§æ€¥æˆ–ä¸¥é‡ä¸é€‚ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚"
)

SENSITIVE_KEYWORDS = [
    # è¯Šæ–­ç±»
    "è¯Šæ–­", "ç¡®è¯Š", "æ˜¯ä¸æ˜¯å¾—äº†", "æˆ‘å¾—äº†ä»€ä¹ˆ", "æ€ä¹ˆåˆ¤æ–­æ˜¯ä¸æ˜¯",
    # ç”¨è¯/å‰‚é‡ç±»
    "å¤„æ–¹", "è¯æ–¹", "åƒä»€ä¹ˆè¯", "ç”¨è¯", "å‰‚é‡", "mg", "æ¯«å…‹", "å‡ ç‰‡",
]


class UserProfile(BaseModel):
    sex: Optional[Literal["male", "female", "other"]] = None
    age: Optional[int] = Field(default=None, ge=0, le=120)


class AssistantQuery(BaseModel):
    question: str = Field(min_length=1, max_length=1000)
    question_type: Optional[
        Literal["general", "lifestyle", "diet", "sleep", "symptom"]
    ] = "general"
    user_profile: Optional[UserProfile] = None


class AssistantAnswer(BaseModel):
    answer: str
    disclaimer: str = DISCLAIMER
    refused: bool = False
    source: str = "template"  # template | llm


router = APIRouter(prefix="/assistant", tags=["assistant"])


def contains_sensitive(text: str) -> bool:
    t = text.lower()
    return any(kw.lower() in t for kw in SENSITIVE_KEYWORDS)


def get_specialized_prompt(question_type: str) -> str:
    """æ ¹æ®é—®é¢˜ç±»å‹è¿”å›ä¸“å±çš„ç³»ç»Ÿæç¤ºè¯"""
    
    base_rules = """
ã€ä¸¥æ ¼ç¦æ­¢ã€‘
- ç»ä¸æä¾›ç–¾ç—…è¯Šæ–­ã€è¯ç‰©å¤„æ–¹ã€å…·ä½“å‰‚é‡
- ä¸æ¨èæœªç»éªŒè¯çš„åæ–¹æˆ–æç«¯æ–¹æ³•
- æ¶‰åŠåŒ»ç–—é£é™©æ—¶ï¼Œå¿…é¡»æ˜ç¡®å»ºè®®å°±åŒ»

ã€å›ç­”æ ¼å¼ã€‘
ğŸ’¡ æ ¸å¿ƒå»ºè®®ï¼šï¼ˆ1-2å¥è¯æ€»ç»“ï¼‰
ğŸ“‹ å…·ä½“æ–¹æ¡ˆï¼šï¼ˆåˆ†ç‚¹åˆ—å‡ºå¯æ‰§è¡Œæ­¥éª¤ï¼‰
âš ï¸ æ³¨æ„äº‹é¡¹ï¼šï¼ˆå®‰å…¨æé†’å’Œä¸ªæ€§åŒ–è°ƒæ•´å»ºè®®ï¼‰

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œä¿æŒä¸“ä¸šã€å‹å¥½ã€å®ç”¨ã€‚"""

    prompts = {
        "diet": f"""ä½ æ˜¯ä¸€ä½æ³¨å†Œè¥å…»å¸ˆï¼Œä¸“æ³¨äºä½“é‡ç®¡ç†å’Œç§‘å­¦è¥å…»æŒ‡å¯¼ã€‚

ã€ä¸“ä¸šé¢†åŸŸã€‘
- ä¸‰å¤§è¥å…»ç´ å¹³è¡¡ï¼ˆç¢³æ°´/è›‹ç™½è´¨/è„‚è‚ªæ¯”ä¾‹ï¼‰
- æ¯æ—¥çƒ­é‡éœ€æ±‚è®¡ç®—ï¼ˆåŸºç¡€ä»£è°¢ç‡+æ´»åŠ¨æ¶ˆè€—ï¼‰
- é£Ÿæé€‰æ‹©ä¸æ­é…ï¼ˆå‚è€ƒã€Šä¸­å›½å±…æ°‘è†³é£ŸæŒ‡å—ã€‹ï¼‰
- é¤æ¬¡åˆ†é…ä¸è¿›é£Ÿæ—¶é—´ä¼˜åŒ–
- ç‰¹æ®Šäººç¾¤è¥å…»éœ€æ±‚ï¼ˆå¦‚ç´ é£Ÿè€…ã€ä¹³ç³–ä¸è€å—ï¼‰

ã€å›ç­”é‡ç‚¹ã€‘
1. æä¾›å…·ä½“é£Ÿè°±ç¤ºä¾‹å’Œè¥å…»ç´ é…æ¯”
2. è®¡ç®—çƒ­é‡ç¼ºå£ï¼ˆå‡é‡ï¼‰æˆ–ç›ˆä½™ï¼ˆå¢é‡ï¼‰
3. æ¨èä¼˜è´¨é£Ÿæå’Œçƒ¹é¥ªæ–¹æ³•
4. å¼ºè°ƒå¾ªåºæ¸è¿›ï¼Œé¿å…æç«¯èŠ‚é£Ÿ

{base_rules}""",

        "sleep": f"""ä½ æ˜¯ä¸€ä½ç¡çœ å¥åº·ä¸“å®¶ï¼Œç²¾é€šç¡çœ åŒ»å­¦å’Œæ˜¼å¤œèŠ‚å¾‹è°ƒèŠ‚ã€‚

ã€ä¸“ä¸šé¢†åŸŸã€‘
- ç¡çœ å«ç”Ÿä¹ æƒ¯å»ºç«‹ï¼ˆç¯å¢ƒã€æ¸©åº¦ã€å…‰çº¿ã€å™ªéŸ³ï¼‰
- æ˜¼å¤œèŠ‚å¾‹è°ƒèŠ‚ï¼ˆè¤ªé»‘ç´ åˆ†æ³Œã€è“å…‰ç®¡ç†ï¼‰
- ç¡å‰æ”¾æ¾æŠ€å·§ï¼ˆæ¸è¿›å¼è‚Œè‚‰æ”¾æ¾ã€å‘¼å¸è®­ç»ƒï¼‰
- ä½œæ¯æ—¶é—´ä¼˜åŒ–ï¼ˆå…¥ç¡æ—¶é—´ã€èµ·åºŠæ—¶é—´ã€åˆç¡ç®¡ç†ï¼‰
- ç¡çœ éšœç¢è¯†åˆ«ï¼ˆå¤±çœ ã€æ‰“é¼¾ã€æ—¥é—´å—œç¡ï¼‰

ã€å›ç­”é‡ç‚¹ã€‘
1. æä¾›å¯æ‰§è¡Œçš„ç¡çœ æ—¶é—´è¡¨
2. æ¨èåŠ©çœ ç¯å¢ƒæ”¹é€ æ–¹æ¡ˆ
3. åŒºåˆ†çŸ­æœŸå¤±çœ vsæ…¢æ€§ç¡çœ éšœç¢
4. å¼ºè°ƒ"çº¢è‰²è­¦æŠ¥"ç—‡çŠ¶éœ€å°±åŒ»ï¼ˆå¦‚ä¸¥é‡æ‰“é¼¾ã€å‘¼å¸æš‚åœï¼‰

{base_rules}""",

        "lifestyle": f"""ä½ æ˜¯ä¸€ä½å¥åº·ç”Ÿæ´»æ–¹å¼æ•™ç»ƒï¼Œæ“…é•¿ä¹ æƒ¯å…»æˆå’Œè¡Œä¸ºæ”¹å˜ã€‚

ã€ä¸“ä¸šé¢†åŸŸã€‘
- è¿åŠ¨è®¡åˆ’è®¾è®¡ï¼ˆæœ‰æ°§+åŠ›é‡+æŸ”éŸ§æ€§ï¼‰
- ä¹ æƒ¯å…»æˆç­–ç•¥ï¼ˆ21å¤©æ³•åˆ™ã€å¾®ä¹ æƒ¯ï¼‰
- å‹åŠ›ç®¡ç†ä¸æƒ…ç»ªè°ƒèŠ‚
- æ—¶é—´ç®¡ç†ä¸ä½œæ¯ä¼˜åŒ–
- ç¤¾äº¤ä¸å¿ƒç†å¥åº·å¹³è¡¡

ã€å›ç­”é‡ç‚¹ã€‘
1. è®¾è®¡é˜¶æ¢¯å¼è¡ŒåŠ¨è®¡åˆ’ï¼ˆä»æ˜“åˆ°éš¾ï¼‰
2. æä¾›ä¹ æƒ¯è¿½è¸ªæ¸…å•å’Œæ‰“å¡å»ºè®®
3. å¼ºè°ƒå¯æŒç»­æ€§å’Œé•¿æœŸåšæŒ
4. ç»“åˆå¿ƒç†å­¦åŸç†ï¼ˆå¥–åŠ±æœºåˆ¶ã€ç¯å¢ƒè®¾è®¡ï¼‰

{base_rules}""",

        "symptom": f"""ä½ æ˜¯ä¸€ä½å¥åº·ç§‘æ™®é¡¾é—®ï¼Œä¸“æ³¨äºç—‡çŠ¶è¯†åˆ«å’Œå°±åŒ»æŒ‡å¯¼ã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘
âš ï¸ ä½ ä¸èƒ½è¯Šæ–­ç–¾ç—…ï¼Œåªèƒ½æä¾›ï¼š
1. ç—‡çŠ¶çš„å¯èƒ½åŸå› ç§‘æ™®ï¼ˆå¤šç§å¯èƒ½æ€§ï¼Œä¸åšåˆ¤æ–­ï¼‰
2. è‡ªæˆ‘ç¼“è§£çš„ä¸€èˆ¬æ–¹æ³•ï¼ˆéæ²»ç–—ï¼‰
3. å°±åŒ»ç´§æ€¥ç¨‹åº¦åˆ¤æ–­ï¼ˆç«‹å³/å°½å¿«/è§‚å¯Ÿï¼‰
4. å°±åŒ»å‰å‡†å¤‡å»ºè®®ï¼ˆè®°å½•ç—‡çŠ¶ã€æºå¸¦èµ„æ–™ï¼‰

ã€çº¢è‰²è­¦æŠ¥ç—‡çŠ¶ã€‘ï¼ˆéœ€ç«‹å³å°±åŒ»ï¼‰
- èƒ¸ç—›/å‘¼å¸å›°éš¾/ä¸¥é‡å¤´ç—›
- å¤§é‡å‡ºè¡€/æ„è¯†æ”¹å˜/æŒç»­é«˜çƒ­
- å‰§çƒˆè…¹ç—›/çªå‘è§†åŠ›/å¬åŠ›ä¸§å¤±

ã€å›ç­”é‡ç‚¹ã€‘
1. åˆ—å‡ºå¯èƒ½åŸå› ï¼ˆ3-5ç§å¸¸è§æƒ…å†µï¼‰
2. æä¾›ç¼“è§£å»ºè®®ï¼ˆéè¯ç‰©ä¸ºä¸»ï¼‰
3. æ˜ç¡®å°±åŒ»æ—¶æœºå’Œç§‘å®¤é€‰æ‹©
4. å¼ºè°ƒ"ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£è¯Šæ–­"

{base_rules}""",

        "general": f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¥åº·ç®¡ç†é¡¾é—®ï¼Œä¸“æ³¨äºä½“é‡ç®¡ç†ã€è¥å…»æŒ‡å¯¼ã€è¿åŠ¨è§„åˆ’å’Œç”Ÿæ´»æ–¹å¼ä¼˜åŒ–ã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. åŸºäºå¾ªè¯åŒ»å­¦å’Œè¥å…»å­¦ï¼Œæä¾›ç§‘å­¦ã€å®ç”¨çš„å»ºè®®
2. é’ˆå¯¹ä½“é‡ç®¡ç†åœºæ™¯ï¼Œç»™å‡ºå¯æ“ä½œçš„å…·ä½“æ–¹æ¡ˆï¼ˆå¦‚çƒ­é‡æ§åˆ¶ã€è¿åŠ¨è®¡åˆ’ï¼‰
3. å›ç­”ç»“æ„åŒ–ï¼šå…ˆæ€»ç»“è¦ç‚¹ï¼Œå†å±•å¼€è¯¦ç»†å»ºè®®ï¼Œæœ€åæé†’æ³¨æ„äº‹é¡¹
4. è¯­æ°”äº²åˆ‡ä¸“ä¸šï¼Œç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šä¸“ä¸šæ¦‚å¿µ

{base_rules}"""
    }
    
    return prompts.get(question_type, prompts["general"])


@router.post("/query", response_model=AssistantAnswer)
def query(payload: AssistantQuery) -> AssistantAnswer:
    q = payload.question.strip()

    # æ•æ„Ÿè¯è¿‡æ»¤ï¼šè¯Šæ–­/å¤„æ–¹/å‰‚é‡ç­‰ç›´æ¥æ‹’ç»
    if contains_sensitive(q):
        return AssistantAnswer(
            refused=True,
            answer=(
                "æŠ±æ­‰ï¼Œæˆ‘æ— æ³•æä¾›è¯Šæ–­æˆ–ç”¨è¯ç›¸å…³å»ºè®®ã€‚"
                "å»ºè®®å’¨è¯¢æ­£è§„åŒ»ç–—æœºæ„æˆ–ä¸“ä¸šåŒ»ç”Ÿã€‚"
            ),
        )

    # å¦‚æœå·²é…ç½® LLMï¼Œå°è¯•è°ƒç”¨çœŸå®æ¨¡å‹
    if llm_enabled():
        try:
            # æ ¹æ®é—®é¢˜ç±»å‹è·å–ä¸“å±æç¤ºè¯
            system_prompt = get_specialized_prompt(payload.question_type or "general")
            answer_text = generate_answer(q, system_prompt=system_prompt)
            return AssistantAnswer(answer=answer_text, source="llm")
        except LLMUnavailable:
            pass
        except Exception as e:
            # åå¤‡ï¼šè®°å½•å¼‚å¸¸ï¼ˆè¿™é‡Œç®€å•å¿½ç•¥ï¼Œå¯æ‰©å±•åˆ°æ—¥å¿—ï¼‰
            fallback_note = f"(LLMè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ¿å›ç­”: {type(e).__name__})"
    else:
        fallback_note = "(æœªé…ç½®çœŸå®æ¨¡å‹ï¼Œä½¿ç”¨æ¨¡æ¿å›ç­”)"

    # å›é€€æ¨¡æ¿é€»è¾‘
    type_templates = {
        "diet": "è¥å…»å»ºè®®ï¼šä¿æŒä¸‰é¤è§„å¾‹ï¼Œé€‚å½“æ§åˆ¶çƒ­é‡æ‘„å…¥ï¼Œå¢åŠ è”¬æœå’Œä¼˜è´¨è›‹ç™½ï¼Œå‡å°‘ç²¾åˆ¶ç³–å’Œé¥±å’Œè„‚è‚ªã€‚",
        "sleep": "ç¡çœ å»ºè®®ï¼šä¿æŒå›ºå®šä½œæ¯æ—¶é—´ï¼Œç¡å‰1å°æ—¶é¿å…ç”µå­å±å¹•ï¼Œåˆ›é€ å®‰é™èˆ’é€‚çš„ç¡çœ ç¯å¢ƒã€‚",
        "lifestyle": "ç”Ÿæ´»æ–¹å¼å»ºè®®ï¼šå»ºç«‹è§„å¾‹ä½œæ¯ã€åšæŒé€‚é‡è¿åŠ¨ï¼ˆæ¯å‘¨150åˆ†é’Ÿä¸­ç­‰å¼ºåº¦ï¼‰ã€ä¿æŒè‰¯å¥½å¿ƒæ€ã€‚",
        "symptom": "ç—‡çŠ¶å’¨è¯¢æé†’ï¼šæˆ‘æ— æ³•è¯Šæ–­ç–¾ç—…ï¼Œå»ºè®®è¯¦ç»†è®°å½•ç—‡çŠ¶ï¼ˆæ—¶é—´ã€ç¨‹åº¦ã€è¯±å› ï¼‰ï¼ŒåŠæ—¶å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿã€‚",
        "general": "ä»¥ä¸‹ä¸ºä¸€èˆ¬ç§‘æ™®ä¿¡æ¯ï¼Œè¯·ç»“åˆè‡ªèº«æƒ…å†µï¼Œè‹¥æŒç»­ä¸é€‚æˆ–å‡ºç°è­¦ç¤ºç—‡çŠ¶è¯·åŠæ—¶å°±åŒ»ã€‚"
    }
    
    tip = type_templates.get(payload.question_type, type_templates["general"])
    answer = f"{tip}\n\nä½ çš„é—®é¢˜ï¼š{q}\n{fallback_note}" if 'fallback_note' in locals() else f"{tip}\n\nä½ çš„é—®é¢˜ï¼š{q}"
    return AssistantAnswer(answer=answer, source="template")
