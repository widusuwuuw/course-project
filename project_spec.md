# Omnihealth 软件工程课程项目开发计划（6 周分段式）

## 1. 项目概述

Omnihealth 是一个面向 **大学生和年轻上班族** 的轻量健康助手 App，核心参考方向为：

- **丁香医生式健康信息 & 问答**：提供安全的健康科普和生活方式建议，但绝不做诊断或开药。
- **MyFitnessPal 式健康日志 & 趋势分析**：支持体重等健康数据的记录与可视化趋势分析。

本项目重点是 **软件工程实践**，而不是自研 AI 模型：

- 核心业务逻辑（健康日志建模、趋势分析、规则引擎、预问诊流程）全部在后端自己实现；
- LLM（大模型）仅作为“自然语言解释层”，负责回答问题和润色解释，不替代系统设计。

技术栈预期：

- 前端：React Native + Expo + TypeScript
- 后端：Python + Flask（或 FastAPI）+ PostgreSQL + SQLAlchemy
- 测试：Pytest（后端）、Jest + React Native Testing Library（前端）
- 其他：JWT 鉴权、简单 Admin 后台（Flask-Admin 或自写）

---

## 2. 功能范围（简要）

### 核心功能

- 用户注册 / 登录 / JWT 鉴权
- 健康日志：体重记录 + 列表展示 + 趋势图
- 健康助手（AI 问答）：
  - 预问诊（问题分类 + 健康档案）
  - 带统一免责声明
  - 敏感词过滤（禁止诊断和用药建议）
- 体检指标模块：
  - 手动录入体检指标
  - 本地规则判断高/低/正常（参考区间表）
  - 提供基于科普的指标解释（可结合 LLM 输出）

### 工程增强

- 自动化测试（后端 Pytest + 前端 Jest）
- Admin 后台：
  - 查看用户、健康日志、体检指标
  - 管理参考区间和健康小贴士内容
- 聊天历史持久化：简单的 Chat Sessions + Messages
- 健康日志扩展：睡眠、饮水、血压、心情等（视时间而定）

---

## 3. 六周分段式开发计划（1 周 1 个 Sprint）

> 总体目标：  
> - 前 3 周完成 **MVP 可运行版本**；  
> - 第 4 周补齐体检指标与规则引擎；  
> - 第 5 周做 Admin + 聊天历史 + 日志扩展；  
> - 第 6 周做自动化测试与优化，形成“工程化项目”。

---

### Week 1 · Sprint 1：项目基建 + 用户体系 + 健康日志核心

**目标**：让项目“跑起来”，实现最基本的用户体系和体重记录功能。

**前端任务：**

- 初始化 Expo + React Native + TypeScript 项目结构。
- 实现以下页面的基本 UI：
  - 登录页（Email + Password）
  - 注册页
  - Dashboard 空壳页面（后续填充）
- 实现 JWT 的本地存储（AsyncStorage）和简单的登录状态管理。

**后端任务：**

- 初始化 Flask 项目结构，配置 PostgreSQL 连接。
- 建立 `users`、`health_logs` 基础数据表：
  - `users`：user_id, email, password_hash, created_at
  - `health_logs`：log_id, user_id, metric_type（先固定为 weight）, value1, unit, logged_at
- 实现以下接口：
  - `POST /register`：用户注册
  - `POST /login`：用户登录，返回 JWT
  - `GET /health-logs`：获取当前用户的体重日志
  - `POST /health-logs`：新增一条体重记录

**完成标志：**

- 用户可以注册、登录。
- 用户可以在 App 中记录体重，并看到自己的体重记录列表。

---

### Week 2 · Sprint 2：AI 健康助手（最小可用版）+ 预问诊基础

**目标**：实现一个带基础预问诊和免责声明的健康助手聊天界面。

**前端任务：**

- 实现健康助手页面：
  - 聊天气泡 UI（用户消息 + 助手消息）
  - 文本输入框 + 发送按钮
  - 显示“正在生成回答...”的 loading 状态。
- 添加“问题类型”选择（预问诊简化版）：
  - 按钮或下拉框：
    - 一般健康科普
    - 生活方式建议（饮食/睡眠/运动）
    - 体检指标相关问题
  - 将问题类型一并发送给后端。

**后端任务：**

- 建立简化版 `user_profiles`（可先只用 memory，或只存性别/年龄段）。
- 实现 `/assistant/query` 接口：
  - 输入：用户问题 + 问题类型 + 用户基本档案（如有）。
  - 统一拼接系统 Prompt：
    - 明确“不能诊断/不能开药/仅做科普”的限制。
    - 要求回答前自动加一段免责声明文本。
  - 对敏感关键词进行基础过滤（例如诊断、药名、剂量等，先做简单字符串包含判断）。
  - 调用 LLM（如 OpenAI API）生成回答。
  - 返回给前端。

**完成标志：**

- 用户可以在 App 中向健康助手提问并收到回答。
- 回答永远带有统一免责声明。
- 不合理/危险问题会被简单拒绝回答。

---

### Week 3 · Sprint 3：体重趋势图 + Dashboard 完成 + 规则引擎雏形

**目标**：把体重记录从“列表”升级为“可视化 + 简单趋势分析”。

**前端任务：**

- 在 Dashboard 中实现：
  - 最近 7 天的体重折线图。
  - 简要数值：本周平均体重、与上周的差值。
- 编写可复用的图表组件（如 `WeightChart`）。

**后端任务：**

- 在 `health_logs` 的基础上新增趋势分析接口：
  - `GET /health-logs/trends`：
    - 返回最近 N 天的体重数据点；
    - 返回本周 vs 上周的平均值对比；
    - 给出简单趋势判断：上升 / 下降 / 基本稳定。
- 封装简单规则引擎函数，例如：
  - 根据体重变化幅度和天数判断趋势。

**完成标志：**

- Dashboard 能展示体重折线图以及简要趋势说明。
- 趋势分析完全由后端逻辑完成，不依赖 AI。

---

### Week 4 · Sprint 4：体检指标模块 + 异常值判断（无 OCR）

**目标**：实现一个完整的“体检指标录入与解释”模块，体现非 AI 的专业逻辑。

**前端任务：**

- 体检指标录入页面：
  - 选择体检日期。
  - 选择体检项目（如 ALT、AST、LDL、血压等）。
  - 手动输入数值和单位。
- 体检指标列表页面：
  - 按体检报告分组查看各项指标。
  - 异常值高亮：偏高用红色，偏低用蓝色。

**后端任务：**

- 数据表设计与实现：
  - `lab_reports`：report_id, user_id, report_date, report_name, created_at
  - `lab_report_metrics`：metric_id, report_id, metric_name, value, unit, reference_range, status
  - `reference_ranges`：metric_name, min_value, max_value, unit 等
- 本地规则引擎：
  - 根据 `reference_ranges` 中的区间，判断指标是 High / Low / Normal；
  - 保存结果到 `status` 字段中。
- 指标解释接口（可选结合 LLM）：
  - 输入：某个指标及其状态；
  - 输出：基础科普说明（可以事先写好模板，也可以结合 LLM 用自然语言表达）。

**完成标志：**

- 用户可以录入体检指标，并在 App 中看到高低风险标记。
- 所有高/低/正常的判断都是由本地规则完成，不依赖 AI。

---

### Week 5 · Sprint 5：Admin 后台 + 聊天历史 + 健康日志扩展

**目标**：从“课程 Demo”进化为“工程化项目”：加入后台系统、历史记录和更多日志维度。

**后端任务：**

- 引入 Admin（优先用 Flask-Admin / 类似库）：
  - 管理用户：查看列表、禁用账号（简单字段）。
  - 管理健康日志：按用户查看记录（脱敏）。
  - 管理体检指标与参考区间。
- 聊天历史：
  - 新表 `chat_sessions`、`chat_messages`；
  - 每次问答持久化存入数据库；
  - 为 Admin 提供简单历史查看能力（仅用于开发/教学，不泄露隐私）。
- 健康日志扩展：
  - 在 `health_logs` 中支持多种 `metric_type`：
    - `weight`、`sleep_hours`、`water_intake`、`blood_pressure`、`mood`（可以先选 1–2 个实现）。

**前端任务：**

- 健康助手会话列表页（可选简单实现）：
  - 显示最近几次会话。
  - 点击进入具体聊天内容（加载历史）。
- 健康日志扩展录入表单：
  - 睡眠时长、饮水量等简单录入页面。

**完成标志：**

- 后端有一个简单可用的 Admin 后台。
- 聊天记录可以保存和查看（至少在后台可见）。
- 健康日志支持至少两种以上的指标类型。

---

### Week 6 · Sprint 6：自动化测试 + 性能与安全优化 + 文档

**目标**：完成工程化收尾，确保质量，并输出可交付的文档。

**后端测试（Pytest）：**

- Auth 测试：注册 / 登录 / Token 校验。
- Health Logs 测试：增删查改、权限限制。
- Lab Reports 测试：体检指标录入与查询。
- 规则引擎测试：高/低/正常、趋势判断。
- AI 接口封装测试：对 LLM 进行 mock，验证免责声明和敏感词过滤逻辑。

**前端测试（Jest）：**

- 登录表单交互测试。
- 体重记录页面测试（输入 + 提交）。
- 趋势图组件渲染测试。
- 聊天页面的基本交互测试（输入、发送、显示回复）。

**文档与优化：**

- 简要的 API 文档（接口列表、参数说明）。
- 一份面向用户/老师的“系统使用说明”。
- 对较慢的接口做基础优化（添加索引、减少 N+1 查询等）。
- 检查敏感信息是否没有写死在代码中（使用 .env）。

**完成标志：**

- 有一套可运行的测试用例（能自动跑）。
- 项目结构清晰，文档齐全，便于老师审阅和同学维护。
- 工程质量可在汇报中重点展示。

---

## 4. 对 AI Coding Assistant（如 Copilot、Cursor）的期望

在本项目中，我们希望 AI 编码助手能够：

- 根据本文件描述的目标和分段式计划，为当前 Sprint 生成合适的代码片段、接口实现和组件框架。
- 在实现新功能时，自动遵循本项目设定的：
  - 技术栈（React Native + Flask + PostgreSQL）
  - 模块划分（前端页面 / 后端路由 / 服务层 / 规则引擎）
  - 安全边界（不提供医疗诊断或用药建议）

开发时的使用方式建议：

- 每次开始一个 Sprint，先在 VSCode 中打开本文件，让 Copilot 了解当前迭代目标。
- 在实现某个模块前，把相关需求片段复制到代码文件顶部作为注释，帮助 Copilot 更好地补全代码。
- 定期更新本文件的“进度状态”和“新的设计决策”，保持文档与代码同步。

---

## 5. 工程决策与进度（滚动更新）

- 2025-11-15：后端框架选择 FastAPI；初始化后端骨架（注册/登录/JWT、体重日志 CRUD、pytest）。
- 数据库策略：开发使用 SQLite 默认配置，生产/课程演示建议 PostgreSQL（`DATABASE_URL` 可切换）。
- 运行入口：`uvicorn app.main:app --reload --app-dir backend`，Swagger 位于 `/docs`。
- 2025-11-15：前端 Expo + React Native + TS 初始化，完成登录/注册/体重日志最小功能；后端启用 CORS 以便联调。
